<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivChat - Developer ADITdeveloper</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* Reset dan variabel CSS */
        :root {
            --primary: #0088cc;
            --primary-dark: #006699;
            --secondary: #25d366;
            --light: #f0f0f0;
            --dark: #202c33;
            --darker: #111b21;
            --white: #ffffff;
            --gray: #8696a0;
            --gray-light: #d1d7db;
            --success: #25d366;
            --warning: #ffa500;
            --danger: #dc3545;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--darker);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout utama */
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background-color: var(--darker);
        }

        /* Sidebar */
        .sidebar {
            width: 30%;
            min-width: 300px;
            background-color: var(--dark);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 15px;
            background-color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 12px;
            color: var(--gray);
        }

        .sidebar-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .icon-btn:hover {
            color: var(--white);
        }

        .search-container {
            padding: 10px 15px;
            background-color: var(--dark);
        }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            background-color: var(--darker);
            border: none;
            border-radius: 20px;
            color: var(--white);
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .chat-item {
            display: flex;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .chat-item.active {
            background-color: rgba(0, 136, 204, 0.2);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 15px;
        }

        .chat-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: bold;
            font-size: 16px;
        }

        .chat-time {
            font-size: 12px;
            color: var(--gray);
        }

        .chat-preview {
            display: flex;
            align-items: center;
            color: var(--gray);
            font-size: 14px;
        }

        .chat-preview p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .unread-badge {
            background-color: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Area Chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--darker);
            position: relative;
        }

        .chat-header-area {
            padding: 15px;
            background-color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-status {
            font-size: 12px;
            color: var(--gray);
        }

        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            margin-right: 5px;
        }

        .typing-indicator {
            font-style: italic;
            color: var(--primary);
            font-size: 12px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--primary);
            border-top-right-radius: 0;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--dark);
            border-top-left-radius: 0;
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .sender-name {
            font-weight: bold;
            font-size: 14px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.8;
            margin-left: 10px;
        }

        .message-content {
            word-wrap: break-word;
        }

        .message-status {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
            font-size: 12px;
        }

        .reaction-container {
            display: flex;
            margin-top: 5px;
            gap: 5px;
        }

        .reaction {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 2px 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 12px;
            cursor: pointer;
            padding: 2px 5px;
        }

        .input-container {
            padding: 15px;
            background-color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            background-color: var(--darker);
            border: none;
            border-radius: 20px;
            color: var(--white);
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }

        .message-input:focus {
            outline: none;
        }

        .send-btn {
            background-color: var(--primary);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .emoji-btn, .attach-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .emoji-btn:hover, .attach-btn:hover {
            color: var(--white);
        }

        /* Halaman Login/Register */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .auth-box {
            background-color: var(--dark);
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--darker);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            color: var(--white);
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-btn:hover {
            background-color: var(--primary-dark);
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* Notifikasi */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--dark);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsif */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-area {
                width: 100%;
            }
            
            .menu-toggle {
                display: block;
            }
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 15px;
            background-color: var(--dark);
            border-radius: var(--radius);
            padding: 10px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 100;
            max-width: 250px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .emoji-picker.active {
            display: flex;
        }

        .emoji-option {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: var(--transition);
        }

        .emoji-option:hover {
            transform: scale(1.2);
        }

        /* Halaman Setelan */
        .settings-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-label {
            font-size: 14px;
        }

        .settings-value {
            font-size: 14px;
            color: var(--gray);
        }

        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border: 2px solid white;
        }

        /* Status Page */
        .status-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .status-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            position: relative;
        }

        .status-avatar::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--dark);
        }

        .status-avatar.online::after {
            background-color: var(--success);
        }

        .status-avatar.offline::after {
            background-color: var(--gray);
        }

        .status-info {
            flex: 1;
        }

        .status-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-time {
            font-size: 12px;
            color: var(--gray);
        }

        .my-status {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--dark);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        /* Edit Profil */
        .edit-profile-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .edit-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
            color: white;
        }

        .avatar-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .avatar-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.active {
            border: 2px solid var(--primary);
        }

        .save-btn {
            background-color: var(--primary);
            border: none;
            border-radius: var(--radius);
            padding: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .save-btn:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">PrivChat</div>
        <div class="loading-spinner"></div>
        <p>Menginisialisasi aplikasi...</p>
    </div>

    <!-- Notifikasi -->
    <div class="notification" id="notification">
        <div class="notification-icon"><i class="fas fa-bell"></i></div>
        <div class="notification-content">
            <div class="notification-title">Pemberitahuan</div>
            <div class="notification-message">Pesan notifikasi akan muncul di sini</div>
        </div>
    </div>

    <!-- Halaman Auth (Login/Register) -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Daftar</div>
            </div>
            
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="loginUsername" placeholder="Username" required>
                    <div class="error-message" id="loginUsernameError"></div>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                <button type="submit" class="auth-btn">Login</button>
            </form>
            
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="registerUsername" placeholder="Username" required>
                    <div class="error-message" id="registerUsernameError"></div>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="registerInfo" placeholder="Info (opsional, maks 100 karakter)" maxlength="100">
                    <div class="error-message" id="registerInfoError"></div>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="registerPassword" placeholder="Password" required>
                    <div class="error-message" id="registerPasswordError"></div>
                </div>
                <button type="submit" class="auth-btn">Daftar</button>
            </form>
        </div>
    </div>

    <!-- Aplikasi Chat Utama -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">
                        <span id="avatarInitial">U</span>
                        <img src="" id="avatarImage" class="avatar-img" style="display: none;">
                    </div>
                    <div class="user-details">
                        <h3 id="userDisplayName">User</h3>
                        <p id="userStatus">Online</p>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="icon-btn" id="statusBtn" title="Status"><i class="fas fa-circle"></i></button>
                    <button class="icon-btn" id="newChatBtn" title="Chat Baru"><i class="fas fa-comment-alt"></i></button>
                    <button class="icon-btn" id="menuBtn" title="Menu"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Cari atau mulai chat baru">
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Daftar chat akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <!-- Area Chat -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header-area">
                <button class="menu-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-contact-info">
                    <div class="avatar">
                        <span id="chatAvatarInitial">C</span>
                        <img src="" id="chatAvatarImage" class="avatar-img" style="display: none;">
                    </div>
                    <div>
                        <h3 id="chatContactName">Pilih chat</h3>
                        <p class="chat-status">
                            <span id="contactStatus">Klik pada kontak untuk memulai percakapan</span>
                            <span class="typing-indicator" id="typingIndicator" style="display: none">sedang mengetik...</span>
                        </p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" title="Cari"><i class="fas fa-search"></i></button>
                    <button class="icon-btn" title="Info"><i class="fas fa-info-circle"></i></button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Pesan akan diisi oleh JavaScript -->
                <div class="welcome-message">
                    <p>Selamat datang di PrivChat! Pilih kontak untuk memulai percakapan.</p>
                </div>
            </div>
            
            <div class="input-container">
                <button class="emoji-btn" id="emojiBtn" title="Emoji"><i class="far fa-smile"></i></button>
                <button class="attach-btn" title="Lampirkan"><i class="fas fa-paperclip"></i></button>
                <textarea class="message-input" id="messageInput" placeholder="Ketik pesan..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn" title="Kirim"><i class="fas fa-paper-plane"></i></button>
            </div>
            
            <div class="emoji-picker" id="emojiPicker">
                <!-- Emoji akan diisi oleh JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal untuk setelan -->
    <div class="modal" id="settingsModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pengaturan</h3>
                <button class="icon-btn" id="closeSettings"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-container">
                <div class="settings-section">
                    <h4 class="settings-title">Profil</h4>
                    <div class="settings-item">
                        <div class="settings-label">Nama Tampilan</div>
                        <div class="settings-value" id="displayNameValue">User</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">Info</div>
                        <div class="settings-value" id="userInfoValue">-</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">ID Pengguna</div>
                        <div class="settings-value" id="userIdValue">-</div>
                    </div>
                    <button class="save-btn" id="editProfileBtn">Edit Profil</button>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-title">Tampilan</h4>
                    <div class="settings-item">
                        <div class="settings-label">Warna Tema</div>
                        <div class="color-picker">
                            <div class="color-option active" style="background-color: #0088cc;" data-color="#0088cc"></div>
                            <div class="color-option" style="background-color: #25d366;" data-color="#25d366"></div>
                            <div class="color-option" style="background-color: #ff6b6b;" data-color="#ff6b6b"></div>
                            <div class="color-option" style="background-color: #a55eea;" data-color="#a55eea"></div>
                            <div class="color-option" style="background-color: #fd9644;" data-color="#fd9644"></div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-title">Privasi</h4>
                    <div class="settings-item">
                        <div class="settings-label">Status Online</div>
                        <div class="settings-value">
                            <label class="switch">
                                <input type="checkbox" id="onlineStatusToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <button class="save-btn" id="logoutBtn">Keluar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk edit profil -->
    <div class="modal" id="editProfileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profil</h3>
                <button class="icon-btn" id="closeEditProfile"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="edit-profile-form">
                    <div class="edit-avatar">
                        <div class="avatar-large" id="editAvatarLarge">
                            <span id="editAvatarInitial">U</span>
                        </div>
                        <div class="avatar-options">
                            <div class="avatar-option active" style="background-color: #0088cc;" data-color="#0088cc"></div>
                            <div class="avatar-option" style="background-color: #25d366;" data-color="#25d366"></div>
                            <div class="avatar-option" style="background-color: #ff6b6b;" data-color="#ff6b6b"></div>
                            <div class="avatar-option" style="background-color: #a55eea;" data-color="#a55eea"></div>
                            <div class="avatar-option" style="background-color: #fd9644;" data-color="#fd9644"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDisplayName">Nama Tampilan</label>
                        <input type="text" class="form-control" id="editDisplayName" placeholder="Nama tampilan">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserInfo">Info (maks 100 karakter)</label>
                        <input type="text" class="form-control" id="editUserInfo" placeholder="Info tentang Anda" maxlength="100">
                    </div>
                    
                    <button class="save-btn" id="saveProfileBtn">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Firebase dengan URL baru
        const firebaseConfig = {
            databaseURL: "https://uvoword-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variabel global
        let currentUser = null;
        let currentChat = null;
        let users = {};
        let chats = {};
        let messages = {};
        let userStatusInterval;

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const authTabs = document.querySelectorAll('.auth-tab');
        const notification = document.getElementById('notification');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const chatList = document.getElementById('chatList');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const userStatus = document.getElementById('userStatus');
        const chatContactName = document.getElementById('chatContactName');
        const contactStatus = document.getElementById('contactStatus');
        const typingIndicator = document.getElementById('typingIndicator');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const statusBtn = document.getElementById('statusBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const menuBtn = document.getElementById('menuBtn');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfileModal = document.getElementById('editProfileModal');
        const closeEditProfile = document.getElementById('closeEditProfile');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Data emoji untuk picker
        const emojis = ['😀', '😂', '🥰', '😎', '😍', '🤔', '👍', '❤️', '🔥', '🎉', '🙏', '💯'];

        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            populateEmojiPicker();
            
            // Simulasikan loading selesai setelah 2 detik
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    checkAuthState();
                }, 500);
            }, 2000);
        });

        // Fungsi inisialisasi aplikasi
        function initializeApp() {
            // Cek apakah ada user yang sudah login di localStorage
            const savedUser = localStorage.getItem('privchat_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth tabs
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchAuthTab(tabName);
                });
            });

            // Login form
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                loginUser(username, password);
            });

            // Register form
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value;
                const info = document.getElementById('registerInfo').value;
                const password = document.getElementById('registerPassword').value;
                registerUser(username, info, password);
            });

            // Chat input
            messageInput.addEventListener('input', function() {
                adjustTextareaHeight();
                if (currentChat) {
                    // Kirim status typing
                    sendTypingStatus(true);
                }
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('blur', function() {
                if (currentChat) {
                    // Hentikan status typing
                    sendTypingStatus(false);
                }
            });

            // Send button
            sendBtn.addEventListener('click', sendMessage);

            // Emoji button
            emojiBtn.addEventListener('click', toggleEmojiPicker);

            // Sidebar toggle (mobile)
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

            // Settings buttons
            menuBtn.addEventListener('click', function() {
                showSettingsModal();
            });

            closeSettings.addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });

            statusBtn.addEventListener('click', function() {
                showStatusPage();
            });

            newChatBtn.addEventListener('click', function() {
                showNewChatModal();
            });

            // Edit profile
            editProfileBtn.addEventListener('click', function() {
                showEditProfileModal();
            });

            closeEditProfile.addEventListener('click', function() {
                editProfileModal.style.display = 'none';
            });

            saveProfileBtn.addEventListener('click', function() {
                saveProfileChanges();
            });

            // Logout
            logoutBtn.addEventListener('click', function() {
                logoutUser();
            });

            // Avatar color options
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update avatar preview
                    const color = this.getAttribute('data-color');
                    document.getElementById('editAvatarLarge').style.background = color;
                });
            });

            // Klik di luar emoji picker untuk menutupnya
            document.addEventListener('click', function(e) {
                if (emojiPicker && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.remove('active');
                }
            });
        }

        // Fungsi untuk beralih antara tab login dan register
        function switchAuthTab(tabName) {
            authTabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            document.querySelectorAll('.auth-form').forEach(form => {
                if (form.id === `${tabName}Form`) {
                    form.classList.add('active');
                } else {
                    form.classList.remove('active');
                }
            });
        }

        // Fungsi untuk mengecek status autentikasi
        function checkAuthState() {
            if (currentUser) {
                // User sudah login, tampilkan aplikasi
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                loadUserData();
                startUserStatusMonitoring();
            } else {
                // User belum login, tampilkan form auth
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        }

        // Fungsi untuk login user
        function loginUser(username, password) {
            // Simulasi login (dalam implementasi nyata, ini akan memverifikasi dengan database)
            const userRef = database.ref('users');
            
            userRef.once('value').then(snapshot => {
                const usersData = snapshot.val();
                let userFound = null;
                
                if (usersData) {
                    for (let userId in usersData) {
                        if (usersData[userId].username === username && usersData[userId].password === password) {
                            userFound = { id: userId, ...usersData[userId] };
                            break;
                        }
                    }
                }
                
                if (userFound) {
                    if (userFound.userstatus === 'banned') {
                        showNotification('Akun Anda telah dibanned', 'error');
                        return;
                    }
                    
                    // Simpan IP address (dalam implementasi nyata, ini akan mengambil IP user)
                    const ipAddress = '192.168.1.1'; // Ini contoh, dalam implementasi nyata gunakan service untuk mendapatkan IP
                    
                    // Update last login dan IP
                    userRef.child(userFound.id).update({
                        lastLogin: new Date().toISOString(),
                        ipAddress: ipAddress,
                        online: true
                    });
                    
                    currentUser = userFound;
                    localStorage.setItem('privchat_user', JSON.stringify(currentUser));
                    
                    showNotification('Login berhasil!', 'success');
                    checkAuthState();
                } else {
                    showNotification('Username atau password salah', 'error');
                }
            });
        }

        // Fungsi untuk mendaftarkan user baru
        function registerUser(username, info, password) {
            // Periksa apakah username sudah digunakan
            const userRef = database.ref('users');
            
            userRef.once('value').then(snapshot => {
                const usersData = snapshot.val();
                let usernameExists = false;
                
                if (usersData) {
                    for (let userId in usersData) {
                        if (usersData[userId].username === username) {
                            usernameExists = true;
                            break;
                        }
                    }
                }
                
                if (usernameExists) {
                    showNotification('Username sudah digunakan', 'error');
                    return;
                }
                
                // Generate user ID mulai dari 5000
                let newUserId = 5000;
                if (usersData) {
                    const userIds = Object.keys(usersData).map(id => parseInt(id));
                    if (userIds.length > 0) {
                        newUserId = Math.max(...userIds) + 1;
                    }
                }
                
                // Simpan IP address (dalam implementasi nyata, ini akan mengambil IP user)
                const ipAddress = '192.168.1.1'; // Ini contoh, dalam implementasi nyata gunakan service untuk mendapatkan IP
                
                // Buat user baru (info bisa kosong)
                const newUser = {
                    username: username,
                    info: info || '', // Info bisa kosong
                    password: password,
                    ipAddress: ipAddress,
                    online: true,
                    userstatus: 'active',
                    avatarColor: '#0088cc', // Warna default
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                userRef.child(newUserId).set(newUser).then(() => {
                    currentUser = { id: newUserId, ...newUser };
                    localStorage.setItem('privchat_user', JSON.stringify(currentUser));
                    
                    showNotification('Pendaftaran berhasil!', 'success');
                    checkAuthState();
                });
            });
        }

        // Fungsi untuk memuat data user
        function loadUserData() {
            if (!currentUser) return;
            
            userDisplayName.textContent = currentUser.username;
            userStatus.textContent = 'Online';
            
            // Set avatar berdasarkan inisial username
            const initial = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('avatarInitial').textContent = initial;
            
            // Set warna avatar
            if (currentUser.avatarColor) {
                userAvatar.style.background = currentUser.avatarColor;
            }
            
            // Load chats
            loadChats();
            
            // Load users
            loadUsers();
        }

        // Fungsi untuk memuat daftar chat
        function loadChats() {
            const chatsRef = database.ref('chats');
            
            chatsRef.on('value', snapshot => {
                const chatsData = snapshot.val();
                chats = chatsData || {};
                
                // Filter chat yang melibatkan user saat ini
                const userChats = [];
                
                for (let chatId in chats) {
                    const chat = chats[chatId];
                    
                    if (chat.type === 'global') {
                        userChats.push({ id: chatId, ...chat });
                    } else if (chat.participants && chat.participants.includes(currentUser.id)) {
                        userChats.push({ id: chatId, ...chat });
                    }
                }
                
                renderChatList(userChats);
            });
        }

        // Fungsi untuk memuat daftar user
        function loadUsers() {
            const usersRef = database.ref('users');
            
            usersRef.on('value', snapshot => {
                const usersData = snapshot.val();
                users = usersData || {};
            });
        }

        // Fungsi untuk merender daftar chat
        function renderChatList(chatList) {
            chatList.innerHTML = '';
            
            if (chatList.length === 0) {
                chatList.innerHTML = '<div class="no-chats">Belum ada percakapan</div>';
                return;
            }
            
            chatList.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                if (currentChat && currentChat.id === chat.id) {
                    chatItem.classList.add('active');
                }
                
                // Tentukan nama chat berdasarkan tipe
                let chatName = 'Unknown';
                let lastMessage = 'Belum ada pesan';
                let chatAvatar = 'C';
                
                if (chat.type === 'global') {
                    chatName = 'Chat Global';
                    chatAvatar = 'G';
                } else if (chat.type === 'private' && chat.participants) {
                    // Cari participant yang bukan user saat ini
                    const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
                    if (otherParticipantId && users[otherParticipantId]) {
                        chatName = users[otherParticipantId].username;
                        chatAvatar = users[otherParticipantId].username.charAt(0).toUpperCase();
                    }
                } else if (chat.type === 'group') {
                    chatName = chat.name || 'Group Chat';
                    chatAvatar = 'G';
                }
                
                // Ambil pesan terakhir jika ada
                if (chat.lastMessage) {
                    lastMessage = chat.lastMessage.text || 'Pesan media';
                }
                
                chatItem.innerHTML = `
                    <div class="chat-avatar">${chatAvatar}</div>
                    <div class="chat-info">
                        <div class="chat-header">
                            <div class="chat-name">${chatName}</div>
                            <div class="chat-time">${formatTime(chat.lastMessageTime)}</div>
                        </div>
                        <div class="chat-preview">
                            <p>${lastMessage}</p>
                            ${chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                chatItem.addEventListener('click', () => {
                    selectChat(chat);
                });
                
                chatList.appendChild(chatItem);
            });
        }

        // Fungsi untuk memilih chat
        function selectChat(chat) {
            currentChat = chat;
            
            // Update UI
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Update header chat
            if (chat.type === 'global') {
                chatContactName.textContent = 'Chat Global';
                contactStatus.textContent = 'Semua pengguna';
            } else if (chat.type === 'private' && chat.participants) {
                const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
                if (otherParticipantId && users[otherParticipantId]) {
                    chatContactName.textContent = users[otherParticipantId].username;
                    contactStatus.textContent = users[otherParticipantId].online ? 'Online' : 'Offline';
                }
            } else if (chat.type === 'group') {
                chatContactName.textContent = chat.name || 'Group Chat';
                contactStatus.textContent = `${chat.participants ? chat.participants.length : 0} anggota`;
            }
            
            // Load messages untuk chat ini
            loadMessages(chat.id);
            
            // Reset unread count
            if (chat.unreadCount > 0) {
                const chatRef = database.ref(`chats/${chat.id}`);
                chatRef.update({ unreadCount: 0 });
            }
            
            // Pada perangkat mobile, tutup sidebar setelah memilih chat
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
            }
        }

        // Fungsi untuk memuat pesan
        function loadMessages(chatId) {
            const messagesRef = database.ref(`messages/${chatId}`);
            
            messagesRef.on('value', snapshot => {
                const messagesData = snapshot.val();
                messages[chatId] = messagesData || {};
                
                renderMessages(chatId);
            });
        }

        // Fungsi untuk merender pesan
        function renderMessages(chatId) {
            messagesContainer.innerHTML = '';
            
            if (!messages[chatId] || Object.keys(messages[chatId]).length === 0) {
                messagesContainer.innerHTML = '<div class="no-messages">Belum ada pesan</div>';
                return;
            }
            
            // Urutkan pesan berdasarkan timestamp
            const sortedMessages = Object.keys(messages[chatId])
                .map(key => ({ id: key, ...messages[chatId][key] }))
                .sort((a, b) => a.timestamp - b.timestamp);
            
            sortedMessages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
                
                const senderName = message.senderId === currentUser.id ? 'Anda' : 
                                 (users[message.senderId] ? users[message.senderId].username : 'Unknown');
                
                messageElement.innerHTML = `
                    <div class="message-info">
                        <span class="sender-name">${senderName}</span>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${message.text}</div>
                    ${message.reactions ? `
                        <div class="reaction-container">
                            ${Object.entries(message.reactions).map(([emoji, users]) => 
                                `<div class="reaction">${emoji} ${users.length}</div>`
                            ).join('')}
                        </div>
                    ` : ''}
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="reactToMessage('${chatId}', '${message.id}', '👍')">👍</button>
                        <button class="message-action-btn" onclick="reactToMessage('${chatId}', '${message.id}', '❤️')">❤️</button>
                        <button class="message-action-btn" onclick="reactToMessage('${chatId}', '${message.id}', '😂')">😂</button>
                        ${message.senderId === currentUser.id ? 
                            `<button class="message-action-btn" onclick="deleteMessage('${chatId}', '${message.id}')">Hapus</button>` : ''}
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll ke bawah
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fungsi untuk mengirim pesan
        function sendMessage() {
            if (!currentChat || !messageInput.value.trim()) return;
            
            const messageText = messageInput.value.trim();
            const timestamp = Date.now();
            const messageId = generateMessageId();
            
            // Buat objek pesan
            const message = {
                id: messageId,
                text: messageText,
                senderId: currentUser.id,
                timestamp: timestamp,
                status: 'sent'
            };
            
            // Simpan pesan ke database
            const messageRef = database.ref(`messages/${currentChat.id}/${messageId}`);
            messageRef.set(message);
            
            // Update last message di chat
            const chatRef = database.ref(`chats/${currentChat.id}`);
            chatRef.update({
                lastMessage: message,
                lastMessageTime: timestamp
            });
            
            // Reset input
            messageInput.value = '';
            adjustTextareaHeight();
            
            // Hentikan status typing
            sendTypingStatus(false);
        }

        // Fungsi untuk mengirim status typing
        function sendTypingStatus(isTyping) {
            if (!currentChat) return;
            
            const typingRef = database.ref(`typing/${currentChat.id}/${currentUser.id}`);
            typingRef.set(isTyping ? true : null);
        }

        // Fungsi untuk memantau status typing
        function monitorTypingStatus() {
            if (!currentChat) return;
            
            const typingRef = database.ref(`typing/${currentChat.id}`);
            typingRef.on('value', snapshot => {
                const typingData = snapshot.val();
                let isSomeoneTyping = false;
                
                if (typingData) {
                    for (let userId in typingData) {
                        if (userId !== currentUser.id && typingData[userId]) {
                            isSomeoneTyping = true;
                            break;
                        }
                    }
                }
                
                if (isSomeoneTyping) {
                    typingIndicator.style.display = 'inline';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
        }

        // Fungsi untuk menambah reaksi pada pesan
        function reactToMessage(chatId, messageId, emoji) {
            const reactionRef = database.ref(`messages/${chatId}/${messageId}/reactions/${emoji}`);
            
            reactionRef.transaction(currentReaction => {
                if (currentReaction) {
                    if (!currentReaction.includes(currentUser.id)) {
                        currentReaction.push(currentUser.id);
                    }
                } else {
                    currentReaction = [currentUser.id];
                }
                return currentReaction;
            });
        }

        // Fungsi untuk menghapus pesan
        function deleteMessage(chatId, messageId) {
            if (confirm('Apakah Anda yakin ingin menghapus pesan ini?')) {
                const messageRef = database.ref(`messages/${chatId}/${messageId}`);
                messageRef.remove();
            }
        }

        // Fungsi untuk memulai monitoring status user
        function startUserStatusMonitoring() {
            // Periksa status user setiap 5 detik
            userStatusInterval = setInterval(() => {
                checkUserStatus();
            }, 5000);
        }

        // Fungsi untuk memeriksa status user
        function checkUserStatus() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.id}`);
            
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                
                if (userData) {
                    // Periksa apakah user dibanned
                    if (userData.userstatus === 'banned') {
                        showNotification('Akun Anda telah dibanned', 'error');
                        logoutUser();
                        return;
                    }
                    
                    // Update status online
                    userRef.update({
                        online: true,
                        lastSeen: Date.now()
                    });
                }
            });
        }

        // Fungsi untuk logout
        function logoutUser() {
            if (currentUser) {
                // Update status offline
                const userRef = database.ref(`users/${currentUser.id}`);
                userRef.update({ online: false });
                
                // Hapus dari localStorage
                localStorage.removeItem('privchat_user');
                currentUser = null;
                
                // Hentikan interval
                if (userStatusInterval) {
                    clearInterval(userStatusInterval);
                }
                
                // Kembali ke halaman auth
                checkAuthState();
            }
        }

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'info') {
            notification.querySelector('.notification-message').textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Fungsi untuk menampilkan modal setelan
        function showSettingsModal() {
            if (currentUser) {
                document.getElementById('displayNameValue').textContent = currentUser.username;
                document.getElementById('userInfoValue').textContent = currentUser.info || '-';
                document.getElementById('userIdValue').textContent = currentUser.id;
            }
            
            settingsModal.style.display = 'block';
        }

        // Fungsi untuk menampilkan modal edit profil
        function showEditProfileModal() {
            if (currentUser) {
                document.getElementById('editDisplayName').value = currentUser.username;
                document.getElementById('editUserInfo').value = currentUser.info || '';
                
                // Set avatar color
                const avatarColor = currentUser.avatarColor || '#0088cc';
                document.getElementById('editAvatarLarge').style.background = avatarColor;
                
                // Aktifkan opsi warna yang sesuai
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.getAttribute('data-color') === avatarColor) {
                        option.classList.add('active');
                    }
                });
            }
            
            settingsModal.style.display = 'none';
            editProfileModal.style.display = 'block';
        }

        // Fungsi untuk menyimpan perubahan profil
        function saveProfileChanges() {
            if (!currentUser) return;
            
            const newUsername = document.getElementById('editDisplayName').value.trim();
            const newInfo = document.getElementById('editUserInfo').value.trim();
            const selectedColor = document.querySelector('.avatar-option.active').getAttribute('data-color');
            
            if (!newUsername) {
                showNotification('Nama tampilan tidak boleh kosong', 'error');
                return;
            }
            
            // Periksa apakah username sudah digunakan (kecuali oleh user saat ini)
            const userRef = database.ref('users');
            userRef.once('value').then(snapshot => {
                const usersData = snapshot.val();
                let usernameExists = false;
                
                if (usersData) {
                    for (let userId in usersData) {
                        if (usersData[userId].username === newUsername && userId !== currentUser.id) {
                            usernameExists = true;
                            break;
                        }
                    }
                }
                
                if (usernameExists) {
                    showNotification('Username sudah digunakan', 'error');
                    return;
                }
                
                // Update data user
                userRef.child(currentUser.id).update({
                    username: newUsername,
                    info: newInfo,
                    avatarColor: selectedColor
                }).then(() => {
                    // Update currentUser di localStorage
                    currentUser.username = newUsername;
                    currentUser.info = newInfo;
                    currentUser.avatarColor = selectedColor;
                    localStorage.setItem('privchat_user', JSON.stringify(currentUser));
                    
                    // Update UI
                    userDisplayName.textContent = newUsername;
                    userAvatar.style.background = selectedColor;
                    document.getElementById('avatarInitial').textContent = newUsername.charAt(0).toUpperCase();
                    
                    showNotification('Profil berhasil diperbarui', 'success');
                    editProfileModal.style.display = 'none';
                }).catch(error => {
                    showNotification('Gagal memperbarui profil: ' + error.message, 'error');
                });
            });
        }

        // Fungsi untuk menampilkan halaman status
        function showStatusPage() {
            // Dalam implementasi lengkap, ini akan menampilkan halaman status
            showNotification('Fitur status akan segera hadir!', 'info');
        }

        // Fungsi untuk menampilkan modal chat baru
        function showNewChatModal() {
            // Dalam implementasi lengkap, ini akan menampilkan modal untuk memulai chat baru
            showNotification('Fitur chat baru akan segera hadir!', 'info');
        }

        // Fungsi untuk menampilkan/menyembunyikan emoji picker
        function toggleEmojiPicker() {
            emojiPicker.classList.toggle('active');
        }

        // Fungsi untuk mengisi emoji picker
        function populateEmojiPicker() {
            emojis.forEach(emoji => {
                const emojiOption = document.createElement('span');
                emojiOption.className = 'emoji-option';
                emojiOption.textContent = emoji;
                emojiOption.addEventListener('click', function() {
                    messageInput.value += emoji;
                    messageInput.focus();
                    emojiPicker.classList.remove('active');
                });
                emojiPicker.appendChild(emojiOption);
            });
        }

        // Fungsi untuk menyesuaikan tinggi textarea
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        }

        // Fungsi untuk menghasilkan ID pesan unik
        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Fungsi untuk memformat waktu
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Kurang dari 1 menit
                return 'Baru saja';
            } else if (diff < 3600000) { // Kurang dari 1 jam
                return Math.floor(diff / 60000) + ' mnt';
            } else if (diff < 86400000) { // Kurang dari 1 hari
                return Math.floor(diff / 3600000) + ' jam';
            } else {
                return date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
            }
        }

        // Ekspos fungsi ke global scope untuk digunakan di HTML
        window.reactToMessage = reactToMessage;
        window.deleteMessage = deleteMessage;
    </script>
</body>
</html>
